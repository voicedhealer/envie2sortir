
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { ModernActivitiesSelector } from "@/components/ModernActivitiesSelector"; 
import OpeningHoursInput, { HoursData } from '@/components/forms/OpeningHoursInput';
import SummaryStep, { EstablishmentFormData } from '@/components/forms/SummaryStep';
import AdresseStep, { AddressData } from '@/components/forms/AdresseStep';

// Types
type ProfessionalData = {
  // Donn√©es l√©gales/administratives
  siret: string;
  companyName: string;
  legalStatus: string;
  
  // Donn√©es personnelles du responsable
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  
  // Donn√©es de l'√©tablissement
  establishmentName: string;
  description: string;
  address: AddressData;
  
  // Activit√©s et services
  activities: string[];
  services: string[];
  ambiance: string[];
  
  // Photos
  photos: File[];
  
  // Horaires d'ouverture
  hours: HoursData;
  
  // R√©seaux sociaux
  website?: string;
  instagram?: string;
  facebook?: string;
  
  // Abonnement
  subscriptionPlan: 'free' | 'premium';
};

type FormStep = 1 | 2 | 3 | 4 | 5 | 6;

// Ic√¥nes simples en SVG
const Icons = {
  Camera: () => (
    <svg className="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
  ),
  Upload: () => (
    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
  ),
  Check: () => (
    <svg className="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
    </svg>
  ),
  X: () => (
    <svg className="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
    </svg>
  ),
  Info: () => (
    <svg className="inline w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  ),
  Star: () => (
    <svg className="inline w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
    </svg>
  ),
  Spinner: () => (
    <div className="animate-spin w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
  )
};

// Configuration des cat√©gories et services
const CATEGORIES = {
  bar: {
    label: "Bar / Pub / Brasserie",
    services: [
      "Cocktails maison", "Bi√®res pression", "Vins au verre", "Tapas/Planches",
      "Happy Hour", "Terrasse", "Musique live", "DJ", "√âcrans sport"
    ],
    ambiance: ["D√©contract√©e", "Festive", "Cosy", "Branch√©e", "Sportive", "Romantique"]
  },
  restaurant: {
    label: "Restaurant",
    services: [
      "Menu du jour", "Carte des vins", "Terrasse", "Privatisation",
      "Livraison", "√Ä emporter", "Brunch", "Menu enfant", "V√©g√©tarien/Vegan"
    ],
    ambiance: ["Gastronomique", "Bistrot", "Familiale", "Romantique", "D√©contract√©e"]
  },
  nightclub: {
    label: "Discoth√®que / Club",
    services: [
      "Piste de danse", "Bar", "VIP/Carr√©", "Vestiaire", "Parking",
      "Fumoir", "Terrasse", "√âv√©nements priv√©s"
    ],
    ambiance: ["√âlectro", "Hip-Hop", "Pop/Rock", "Latino", "Ann√©es 80/90", "Clubbing"]
  },
  escape_game: {
    label: "Escape Game",
    services: [
      "Plusieurs salles", "Team building", "Anniversaires", "Parking",
      "Vestiaire", "Espace d√©tente", "Boutique souvenirs"
    ],
    ambiance: ["Horreur", "Aventure", "Myst√®re", "Sci-Fi", "Historique", "Familial"]
  },
  cinema: {
    label: "Cin√©ma",
    services: [
      "Plusieurs salles", "3D/IMAX", "Snack", "Parking",
      "S√©ances matinales", "Avant-premi√®res", "Cin√©ma d'art"
    ],
    ambiance: ["Blockbusters", "Art et essai", "Familial", "Documentaires"]
  }
};

const SUBSCRIPTION_PLANS = {
  free: {
    label: "Plan Gratuit",
    features: [
      "1 photo maximum",
      "Informations de base",
      "Pr√©sence sur la carte",
      "Statistiques limit√©es"
    ],
    price: "0‚Ç¨/mois"
  },
  premium: {
    label: "Plan Premium",
    features: [
      "10 photos maximum",
      "Description d√©taill√©e",
      "Mise en avant dans les r√©sultats",
      "Statistiques avanc√©es",
      "Badge 'Partenaire v√©rifi√©'",
      "Support prioritaire"
    ],
    price: "29‚Ç¨/mois"
  }
};

// Fonction pour r√©cup√©rer les services et ambiances bas√©s sur les activit√©s s√©lectionn√©es
const getActivitiesServicesAndAmbiance = (activities: string[]) => {
  if (!activities || activities.length === 0) return null;
  
  // Mapping des activit√©s vers les cat√©gories de services/ambiances
  const activityMappings: Record<string, keyof typeof CATEGORIES> = {
    // Bars
    'bar_ambiance': 'bar',
    'pub_traditionnel': 'bar',
    'brasserie_artisanale': 'bar',
    'bar_cocktails': 'bar',
    'bar_vins': 'bar',
    'bar_sports': 'bar',
    'rooftop_bar': 'bar',
    'bar_karaoke': 'bar',
    'bar_bi√®res': 'bar',
    
    // Restaurants
    'restaurant_gastronomique': 'restaurant',
    'restaurant_traditionnel': 'restaurant',
    'restaurant_familial': 'restaurant',
    'bistrot': 'restaurant',
    'restaurant_italien': 'restaurant',
    'restaurant_asiatique': 'restaurant',
    'restaurant_oriental': 'restaurant',
    'pizzeria': 'restaurant',
    
    // Fast food ‚Üí restaurant pour l'instant
    'kebab': 'restaurant',
    'burger': 'restaurant',
    'tacos_mexicain': 'restaurant',
    
    // Sorties nocturnes
    'discotheque': 'nightclub',
    'club_techno': 'nightclub',
    'boite_nuit_mainstream': 'nightclub',
    
    // Activit√©s
    'escape_game_horreur': 'escape_game',
    'escape_game_aventure': 'escape_game',
    'bowling': 'escape_game', // Temporaire
    
    // Cin√©ma
    'cinema_mainstream': 'cinema',
    
    // Fallback vers les anciennes cat√©gories
    'bar': 'bar',
    'restaurant': 'restaurant',
    'nightclub': 'nightclub',
    'escape_game': 'escape_game',
    'cinema': 'cinema'
  };
  
  // R√©cup√©rer la premi√®re activit√© mapp√©e pour d√©terminer les services/ambiances
  // TODO: Am√©liorer pour fusionner les services de plusieurs activit√©s
  const firstMappedCategory = activityMappings[activities[0]];
  return firstMappedCategory ? CATEGORIES[firstMappedCategory] : null;
};


export default function ProfessionalRegistrationForm() {
  const router = useRouter();
  const [currentStep, setCurrentStep] = useState<FormStep>(1);
  const [formData, setFormData] = useState<ProfessionalData>({
    siret: "",
    companyName: "",
    legalStatus: "",
    firstName: "",
    lastName: "",
    email: "",
    phone: "",
    establishmentName: "",
    description: "",
    address: {
      street: "",
      postalCode: "",
      city: "",
      latitude: undefined,
      longitude: undefined
    },
    activities: [],
    services: [],
    ambiance: [],
    photos: [],
    hours: {},
    subscriptionPlan: "free"
  });

  const [errors, setErrors] = useState<Record<string, string>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [siretVerification, setSiretVerification] = useState<{
    status: 'idle' | 'loading' | 'valid' | 'invalid';
    data?: any;
  }>({ status: 'idle' });



  // V√©rification SIRET en temps r√©el
  const verifySiret = async (siret: string) => {
    if (siret.length !== 14) return;
    
    setSiretVerification({ status: 'loading' });
    
    try {
      // Simulation d'appel API - √† remplacer par une vraie API
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Simulation de donn√©es retourn√©es
      const mockData = {
        valid: true,
        denomination: "SARL EXEMPLE",
        categorieJuridiqueUniteLegale: "SARL",
        adresse: "123 Rue de la Paix, 21000 Dijon"
      };
      
      setSiretVerification({ status: 'valid', data: mockData });
      setFormData(prev => ({
        ...prev,
        companyName: mockData.denomination || "",
        legalStatus: mockData.categorieJuridiqueUniteLegale || "",
        address: mockData.adresse || ""
      }));
    } catch (error) {
      setSiretVerification({ status: 'invalid' });
    }
  };



  const handleInputChange = (field: keyof ProfessionalData, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    
    if (field === 'siret' && typeof value === 'string') {
      const cleanSiret = value.replace(/\s/g, '');
      setFormData(prev => ({ ...prev, siret: cleanSiret }));
      
      if (cleanSiret.length === 14) {
        verifySiret(cleanSiret);
      }
    }
    
    // Gestion sp√©ciale pour l'adresse (AddressData)
    if (field === 'address' && typeof value === 'object') {
      // L'adresse est d√©j√† mise √† jour par le composant AdresseStep
      console.log('üìç Adresse mise √† jour:', value);
    }
    
    if (errors[field]) {
      setErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[field];
        return newErrors;
      });
    }
  };

  const handleArrayToggle = (field: 'subCategories' | 'services' | 'ambiance', value: string) => {
    setFormData(prev => ({
      ...prev,
      [field]: prev[field].includes(value)
        ? prev[field].filter(item => item !== value)
        : [...prev[field], value]
    }));
  };

  const handlePhotoUpload = (files: FileList) => {
    const maxPhotos = formData.subscriptionPlan === 'premium' ? 10 : 1;
    const newPhotos = Array.from(files).slice(0, maxPhotos - formData.photos.length);
    
    setFormData(prev => ({
      ...prev,
      photos: [...prev.photos, ...newPhotos]
    }));
  };

  const removePhoto = (index: number) => {
    setFormData(prev => ({
      ...prev,
      photos: prev.photos.filter((_, i) => i !== index)
    }));
  };

  const validateStep = (step: FormStep): boolean => {
    const newErrors: Record<string, string> = {};

    switch (step) {
      case 1:
        if (!formData.siret) newErrors.siret = "SIRET requis";
        if (siretVerification.status !== 'valid') newErrors.siret = "SIRET invalide";
        if (!formData.firstName) newErrors.firstName = "Pr√©nom requis";
        if (!formData.lastName) newErrors.lastName = "Nom requis";
        if (!formData.email) newErrors.email = "Email requis";
        if (!formData.phone) newErrors.phone = "T√©l√©phone requis";
        break;
      
      case 2:
        if (!formData.establishmentName) newErrors.establishmentName = "Nom requis";
        if (!formData.address.street || !formData.address.postalCode || !formData.address.city) {
          newErrors.address = "Adresse compl√®te requise (rue, code postal et ville)";
        }
        if (formData.activities.length === 0) newErrors.activities = "S√©lectionnez au moins une activit√©";
        break;
      
      case 3:
        if (formData.services.length === 0) newErrors.services = "S√©lectionnez au moins un service";
        if (formData.ambiance.length === 0) newErrors.ambiance = "S√©lectionnez au moins une ambiance";
        break;
      
      case 4:
        if (formData.photos.length === 0) newErrors.photos = "Au moins une photo requise";
        break;
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const nextStep = () => {
    if (validateStep(currentStep)) {
      setCurrentStep(prev => Math.min(6, prev + 1) as FormStep);
    }
  };

  const prevStep = () => {
    setCurrentStep(prev => Math.max(1, prev - 1) as FormStep);
  };

  const handleSubmit = async () => {
    if (!validateStep(currentStep)) return;
    
    setIsSubmitting(true);
    
    try {
      const formDataToSend = new FormData();
      
      // Ajouter toutes les donn√©es
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'photos') {
          if (Array.isArray(value)) {
            (value as File[]).forEach((photo, index) => {
              formDataToSend.append(`photo_${index}`, photo);
            });
          }
        } else if (key === 'hours') {
          // Traitement sp√©cial pour le champ hours (objet complexe)
          formDataToSend.append(key, JSON.stringify(value));
        } else if (key === 'address') {
          // Traitement sp√©cial pour l'adresse : construction de l'adresse compl√®te
          const addressData = value as AddressData;
          const fullAddress = `${addressData.street}, ${addressData.postalCode} ${addressData.city}`;
          formDataToSend.append('address', fullAddress);
          
          // Ajout des coordonn√©es s√©par√©ment
          if (addressData.latitude !== undefined) {
            formDataToSend.append('latitude', addressData.latitude.toString());
          }
          if (addressData.longitude !== undefined) {
            formDataToSend.append('longitude', addressData.longitude.toString());
          }
        } else if (Array.isArray(value)) {
          formDataToSend.append(key, JSON.stringify(value));
        } else if (value !== undefined && value !== null) {
          formDataToSend.append(key, value.toString());
        }
      });
      
      const response = await fetch('/api/professional-registration', {
        method: 'POST',
        body: formDataToSend,
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Erreur lors de l\'inscription');
      }
      
      // Redirection vers page de confirmation
      alert(result.message);
      router.push(`/etablissements/${result.slug}`);
      
    } catch (error) {
      console.error('Erreur:', error);
      alert(error instanceof Error ? error.message : 'Erreur lors de l\'inscription');
    } finally {
      setIsSubmitting(false);
    }
  };
  

/**
 * Composant de rendu dynamique pour chaque √©tape du formulaire professionnel.
 * Affiche le contenu correspondant √† l'√©tape courante, g√®re la validation front, 
 * et permet d'adapter facilement les contenus pour chaque logique m√©tier.
 *
 * Utilisation : placer `{renderStep()}` dans le JSX parent, et inclure les √©tats n√©cessaires :
 *  - currentStep, formData, errors, handleInputChange, etc.
 */
const renderStep = () => {
  switch (currentStep) {
    // === √âtape 1 : Informations professionnelles et v√©rification SIRET ===
    case 1:
      return (
        <div className="space-y-6">
          <div className="text-center mb-8">
            <h2 className="text-2xl font-bold text-gray-900">
              V√©rification professionnelle
            </h2>
            <p className="text-gray-600 mt-2">
              Nous devons v√©rifier votre statut professionnel pour valider votre inscription
            </p>
          </div>
          {/* Champ SIRET + indication du statut de v√©rification */}
          <div>
            <label className="block text-sm font-medium mb-2">
              Num√©ro SIRET * <Icons.Info />
            </label>
            <div className="relative">
              <input
                type="text"
                value={formData.siret}
                onChange={(e) =>
                  handleInputChange('siret', e.target.value)
                }
                className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                  errors.siret ? 'border-red-500' : 'border-gray-300'
                }`}
                placeholder="14 chiffres (ex: 12345678901234)"
                maxLength={14}
              />
              <div className="absolute right-3 top-3">
                {siretVerification.status === 'loading' && <Icons.Spinner />}
                {siretVerification.status === 'valid' && <Icons.Check />}
                {siretVerification.status === 'invalid' && <Icons.X />}
              </div>
            </div>
            {/* Feedback de v√©rification */}
            {siretVerification.status === 'valid' && siretVerification.data && (
              <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p className="text-sm text-green-800">
                  ‚úì Entreprise v√©rifi√©e: {siretVerification.data.denomination}
                </p>
              </div>
            )}
            {errors.siret && <p className="text-red-500 text-sm mt-1">{errors.siret}</p>}
          </div>

          {/* Champs du responsable */}
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-2">Pr√©nom *</label>
              <input
                type="text"
                value={formData.firstName}
                onChange={(e) => handleInputChange('firstName', e.target.value)}
                className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                  errors.firstName ? 'border-red-500' : 'border-gray-300'
                }`}
              />
              {errors.firstName && <p className="text-red-500 text-sm mt-1">{errors.firstName}</p>}
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Nom *</label>
              <input
                type="text"
                value={formData.lastName}
                onChange={(e) => handleInputChange('lastName', e.target.value)}
                className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                  errors.lastName ? 'border-red-500' : 'border-gray-300'
                }`}
              />
              {errors.lastName && <p className="text-red-500 text-sm mt-1">{errors.lastName}</p>}
            </div>
          </div>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-2">
                Email professionnel *
              </label>
              <input
                type="email"
                value={formData.email}
                onChange={(e) => handleInputChange('email', e.target.value)}
                className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                  errors.email ? 'border-red-500' : 'border-gray-300'
                }`}
              />
              {errors.email && <p className="text-red-500 text-sm mt-1">{errors.email}</p>}
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">T√©l√©phone *</label>
              <input
                type="tel"
                value={formData.phone}
                onChange={(e) => handleInputChange('phone', e.target.value)}
                className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                  errors.phone ? 'border-red-500' : 'border-gray-300'
                }`}
              />
              {errors.phone && <p className="text-red-500 text-sm mt-1">{errors.phone}</p>}
            </div>
          </div>
        </div>
      );
    // === Etape 2 : Informations √©tablissement ===
    case 2:
      return (
        <div className="space-y-6">
          <div className="text-center mb-8">
            <h2 className="text-2xl font-bold text-gray-900">
              Informations sur l‚Äô√©tablissement
            </h2>
            <p className="text-gray-600 mt-2">
              D√©crivez votre √©tablissement pour que les clients le trouvent facilement
            </p>
          </div>
          {/* Nom commercial */}
          <div>
            <label className="block text-sm font-medium mb-2">Nom de l‚Äô√©tablissement *</label>
            <input
              type="text"
              value={formData.establishmentName}
              onChange={(e) => handleInputChange('establishmentName', e.target.value)}
              className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                errors.establishmentName ? 'border-red-500' : 'border-gray-300'
              }`}
              placeholder="Ex: Le Central Bar"
            />
            {errors.establishmentName && <p className="text-red-500 text-sm mt-1">{errors.establishmentName}</p>}
          </div>
          {/* Description */}
          <div>
            <label className="block text-sm font-medium mb-2">Description de l‚Äô√©tablissement</label>
            <textarea
              value={formData.description}
              onChange={(e) => handleInputChange('description', e.target.value)}
              rows={4}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="D√©crivez l‚Äôambiance, les sp√©cialit√©s, etc."
            />
          </div>
          {/* Adresse de l'√©tablissement */}
          <AdresseStep
            value={formData.address}
            onChange={(address) => handleInputChange('address', address)}
            error={errors.address}
          />
          
          {/* Horaires d'ouverture */}
          <OpeningHoursInput 
            value={formData.hours} 
            onChange={(hours) => handleInputChange('hours', hours)} 
          />
          
          {/* Activit√©s propos√©es */}
          <ModernActivitiesSelector
            value={formData.activities}
            onChange={(value) => handleInputChange('activities', value)}
            error={errors.activities}
          />
        </div>
      );

    // === Etape 3 : Services & Ambiances ===
    case 3: {
      const ambianceList = GENERIC_AMBIANCES;
      return (
        <div className="space-y-6">
          <div className="text-center mb-8">
            <h2 className="text-2xl font-bold text-gray-900">
              Services et ambiance
            </h2>
            <p className="text-gray-600 mt-2">
              S√©lectionnez ce que votre √©tablissement propose r√©ellement
            </p>
          </div>
          
          {/* Services universels organis√©s par cat√©gories */}
          <div className="space-y-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900">Services & √âquipements</h3>
              <span className="text-sm text-gray-500">
                {formData.services.length} service{formData.services.length > 1 ? 's' : ''} s√©lectionn√©{formData.services.length > 1 ? 's' : ''}
              </span>
            </div>
            
            {Object.entries(UNIVERSAL_SERVICES).map(([key, category]) => (
              <div key={key} className="border border-gray-200 rounded-lg p-4">
                <div className="flex items-center mb-3">
                  <span className="text-xl mr-2">{category.icon}</span>
                  <h4 className="font-medium text-gray-900">{category.title}</h4>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                  {category.services.map((service: string) => (
                    <label key={service} className="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                      <input
                        type="checkbox"
                        checked={formData.services.includes(service)}
                        onChange={() => handleArrayToggle('services', service)}
                        className="rounded text-blue-600 focus:ring-blue-500"
                      />
                      <span className="text-sm text-gray-700">{service}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>
          
          {/* Ambiances */}
          <div className="border-t pt-6">
            <label className="block text-sm font-medium mb-4">
              Quelle ambiance d√©crit le mieux votre √©tablissement ?
            </label>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {ambianceList.map((amb: string) => (
                <label key={amb} className="flex items-center space-x-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={formData.ambiance.includes(amb)}
                    onChange={() => handleArrayToggle('ambiance', amb)}
                    className="rounded text-blue-600 focus:ring-blue-500"
                  />
                  <span className="text-sm">{amb}</span>
                </label>
              ))}
            </div>
          </div>
        </div>
      );
    }
    // === Etape 4 : Abonnement & photos ===
    case 4:
      return (
        <div className="space-y-6">
          <div className="text-center mb-8">
            <h2 className="text-2xl font-bold text-gray-900">Photos & abonnement</h2>
            <p className="text-gray-600 mt-2">
              Ajoutez une belle photo (ou plusieurs si plan premium) de votre √©tablissement
            </p>
          </div>
          {/* S√©lection du plan */}
          <div className="grid md:grid-cols-2 gap-4 mb-6">
            {Object.entries(SUBSCRIPTION_PLANS).map(([key, plan]) => (
              <div
                key={key}
                className={`p-4 border-2 rounded-lg cursor-pointer transition-all ${
                  formData.subscriptionPlan === key
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
                onClick={() => handleInputChange('subscriptionPlan', key)}
              >
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold">{plan.label}</h3>
                  <span className="text-lg font-bold text-blue-600">{plan.price}</span>
                </div>
                <ul className="text-sm space-y-1">
                  {plan.features.map((feature, idx) => (
                    <li key={idx} className="flex items-center">
                      <Icons.Check />
                      <span className="ml-2">{feature}</span>
                    </li>
                  ))}
                </ul>
                {key === 'premium' && (
                  <div className="mt-2">
                    <Icons.Star />
                    <span className="text-sm text-gray-600 ml-1">Recommand√©</span>
                  </div>
                )}
              </div>
            ))}
          </div>
          {/* Upload des photos */}
          <div>
            <label className="block text-sm font-medium mb-2">
              Photos ({formData.photos.length}/{formData.subscriptionPlan === 'premium' ? 10 : 1})
            </label>
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
              <Icons.Camera />
              <div className="space-y-2 mt-4">
                <p className="text-sm text-gray-600">
                  Glissez vos photos ici ou cliquez pour s√©lectionner
                </p>
                <input
                  type="file"
                  multiple
                  accept="image/*"
                  onChange={(e) => e.target.files && handlePhotoUpload(e.target.files)}
                  className="hidden"
                  id="photo-upload"
                />
                <label
                  htmlFor="photo-upload"
                  className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700"
                >
                  <Icons.Upload />
                  <span className="ml-2">S√©lectionner des photos</span>
                </label>
              </div>
            </div>
            {/* Aper√ßu */}
            {formData.photos.length > 0 && (
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                {formData.photos.map((photo, index) => (
                  <div key={index} className="relative">
                    <img
                      src={URL.createObjectURL(photo)}
                      alt={`Photo ${index + 1}`}
                      className="w-full h-24 object-cover rounded-lg"
                    />
                    <button
                      onClick={() => removePhoto(index)}
                      className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600"
                    >
                      √ó
                    </button>
                  </div>
                ))}
              </div>
            )}
            {errors.photos && <p className="text-red-500 text-sm mt-1">{errors.photos}</p>}
          </div>
        </div>
      );
    // === Etape 5 : R√©seaux sociaux ===
    case 5:
      return (
        <div className="space-y-6">
          <div className="text-center mb-8">
            <h2 className="text-2xl font-bold text-gray-900">R√©seaux sociaux</h2>
            <p className="text-gray-600 mt-2">
              Ajoutez vos liens r√©seaux sociaux pour am√©liorer votre visibilit√©
            </p>
          </div>
          {/* Liens r√©seaux sociaux */}
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-2">Site web</label>
              <input
                type="url"
                value={formData.website || ''}
                onChange={(e) => handleInputChange('website', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="https://www.votre-site.com"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Instagram</label>
              <input
                type="text"
                value={formData.instagram || ''}
                onChange={(e) => handleInputChange('instagram', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="@votre_compte"
              />
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium mb-2">Facebook</label>
            <input
              type="url"
              value={formData.facebook || ''}
              onChange={(e) => handleInputChange('facebook', e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="https://www.facebook.com/votre-page"
            />
          </div>
        </div>
      );

    // === Etape 6 : R√©capitulatif final ===
    case 6:
      return (
        <div className="space-y-6">
          <SummaryStep 
            data={{
              establishmentName: formData.establishmentName,
              description: formData.description,
              address: `${formData.address.street}, ${formData.address.postalCode} ${formData.address.city}`,
              activities: formData.activities,
              hours: formData.hours,
              services: formData.services,
              ambiance: formData.ambiance,
              photos: formData.photos,
              phone: formData.phone,
              email: formData.email,
              website: formData.website,
              instagram: formData.instagram,
              facebook: formData.facebook,
            }}
            onEdit={(step) => setCurrentStep(step)}
          />
          {/* Conditions d'utilisation */}
          <div className="text-sm text-gray-600">
            <label className="flex items-start space-x-2">
              <input type="checkbox" className="mt-1 rounded text-blue-600 focus:ring-blue-500" required />
              <span>
                J'accepte les{' '}
                <a href="/conditions" className="text-blue-600 underline">
                  conditions g√©n√©rales d'utilisation
                </a>
                {' '}et la{' '}
                <a href="/politique-confidentialite" className="text-blue-600 underline">
                  politique de confidentialit√©
                </a>
              </span>
            </label>
          </div>
        </div>
      );
    // S√©curit√© fallback si √©tape inconnue
    default:
      return <div>Erreur technique : √©tape inconnue.</div>;
  }
};

  return (
    <div className="max-w-4xl mx-auto p-6">
      {/* Progress bar */}
      <div className="mb-8">
        <div className="flex items-center justify-between mb-2">
          {[1, 2, 3, 4, 5, 6].map((step) => (
            <div
              key={step}
              className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                step <= currentStep
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-200 text-gray-600'
              }`}
            >
              {step}
            </div>
          ))}
        </div>
        <div className="w-full bg-gray-200 rounded-full h-2">
          <div
            className="bg-blue-600 h-2 rounded-full transition-all duration-300"
            style={{ width: `${(currentStep / 6) * 100}%` }}
          ></div>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow-lg p-8">
        {renderStep()}

        <div className="flex justify-between mt-8 pt-6 border-t">
          <button
            type="button"
            onClick={prevStep}
            disabled={currentStep === 1}
            className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Pr√©c√©dent
          </button>

          {currentStep < 5 ? (
            <button
              type="button"
              onClick={nextStep}
              className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Suivant
            </button>
          ) : currentStep === 5 ? (
            <button
              type="button"
              onClick={nextStep}
              className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Voir le r√©capitulatif
            </button>
          ) : (
            <button
              type="button"
              onClick={handleSubmit}
              disabled={isSubmitting}
              className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isSubmitting ? 'Inscription en cours...' : 'Finaliser l\'inscription'}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
